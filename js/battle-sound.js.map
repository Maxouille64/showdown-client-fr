{"version":3,"file":"battle-sound.js","names":["BattleBGM","url","loopstart","loopend","sound","timer","undefined","isPlaying","isActuallyPlaying","willRewind","play","resume","actuallyResume","pause","actuallyPause","update","stop","destroy","BattleSound","deleteBgm","currentBgm","getSound","currentTime","volume","bgmVolume","updateTime","clearTimeout","progress","setTimeout","Math","max","current","bgm","soundCache","effectVolume","muted","window","HTMLAudioElement","document","createElement","src","Config","routes","client","playEffect","playSound","effect","loadBgm","replaceBGM","push","soundIndex","indexOf","splice","setMute","loudnessPercentToAmplitudePercent","loudnessPercent","decibels","log","pow","setBgmVolume","setEffectVolume","PS","prefs","subscribeAndRun","key","effectvolume","musicvolume","mute"],"sources":["../src/battle-sound.ts"],"sourcesContent":["\nexport class BattleBGM {\n\t/**\n\t * May be shared with other BGM objects: every battle has its own BattleBGM\n\t * object, but two battles with the same music will have the same HTMLAudioElement\n\t * object.\n\t */\n\tsound?: HTMLAudioElement;\n\turl: string;\n\ttimer: number | undefined = undefined;\n\tloopstart: number;\n\tloopend: number;\n\t/**\n\t * When multiple battles with BGM are open, they will be `isPlaying`, but only the\n\t * first one will be `isActuallyPlaying`. In addition, muting volume or setting\n\t * BGM volume to 0 will set `isActuallyPlaying` to false.\n\t */\n\tisPlaying = false;\n\tisActuallyPlaying = false;\n\t/**\n\t * The sound should be rewound when it next plays.\n\t */\n\twillRewind = true;\n\tconstructor(url: string, loopstart: number, loopend: number) {\n\t\tthis.url = url;\n\t\tthis.loopstart = loopstart;\n\t\tthis.loopend = loopend;\n\t}\n\tplay() {\n\t\tthis.willRewind = true;\n\t\tthis.resume();\n\t}\n\tresume() {\n\t\tthis.isPlaying = true;\n\t\tthis.actuallyResume();\n\t}\n\tpause() {\n\t\tthis.isPlaying = false;\n\t\tthis.actuallyPause();\n\t\tBattleBGM.update();\n\t}\n\tstop() {\n\t\tthis.pause();\n\t\tthis.willRewind = true;\n\t}\n\tdestroy() {\n\t\tBattleSound.deleteBgm(this);\n\t\tthis.pause();\n\t}\n\n\tactuallyResume() {\n\t\tif (this !== BattleSound.currentBgm()) return;\n\t\tif (this.isActuallyPlaying) return;\n\n\t\tif (!this.sound) this.sound = BattleSound.getSound(this.url);\n\t\tif (!this.sound) return;\n\t\tif (this.willRewind) this.sound.currentTime = 0;\n\t\tthis.willRewind = false;\n\t\tthis.isActuallyPlaying = true;\n\t\tthis.sound.volume = BattleSound.bgmVolume / 100;\n\t\tthis.sound.play();\n\t\tthis.updateTime();\n\t}\n\tactuallyPause() {\n\t\tif (!this.isActuallyPlaying) return;\n\t\tthis.isActuallyPlaying = false;\n\t\tthis.sound!.pause();\n\t\tthis.updateTime();\n\t}\n\t/**\n\t * Handles the hard part of looping the sound\n\t */\n\tupdateTime() {\n\t\tclearTimeout(this.timer);\n\t\tthis.timer = undefined;\n\t\tif (this !== BattleSound.currentBgm()) return;\n\t\tif (!this.sound) return;\n\n\t\tconst progress = this.sound.currentTime * 1000;\n\t\tif (progress > this.loopend - 1000) {\n\t\t\tthis.sound.currentTime -= (this.loopend - this.loopstart) / 1000;\n\t\t}\n\n\t\tthis.timer = setTimeout(() => {\n\t\t\tthis.updateTime();\n\t\t}, Math.max(this.loopend - progress, 1));\n\t}\n\n\tstatic update() {\n\t\tconst current = BattleSound.currentBgm();\n\t\tfor (const bgm of BattleSound.bgm) {\n\t\t\tif (bgm.isPlaying) {\n\t\t\t\tif (bgm === current) {\n\t\t\t\t\tbgm.actuallyResume();\n\t\t\t\t} else {\n\t\t\t\t\tbgm.actuallyPause();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport const BattleSound = new class {\n\tsoundCache: {[url: string]: HTMLAudioElement | undefined} = {};\n\n\tbgm: BattleBGM[] = [];\n\n\t// options\n\teffectVolume = 50;\n\tbgmVolume = 50;\n\tmuted = false;\n\n\tgetSound(url: string) {\n\t\tif (!window.HTMLAudioElement) return;\n\t\tif (this.soundCache[url]) return this.soundCache[url];\n\t\ttry {\n\t\t\tconst sound = document.createElement('audio');\n\t\t\tsound.src = 'https://' + Config.routes.client + '/' + url;\n\t\t\tsound.volume = this.effectVolume / 100;\n\t\t\tthis.soundCache[url] = sound;\n\t\t\treturn sound;\n\t\t} catch {}\n\t}\n\n\tplayEffect(url: string) {\n\t\tthis.playSound(url, this.muted ? 0 : this.effectVolume);\n\t}\n\n\tplaySound(url: string, volume: number) {\n\t\tif (!volume) return;\n\t\tconst effect = this.getSound(url);\n\t\tif (effect) {\n\t\t\teffect.volume = volume / 100;\n\t\t\teffect.play();\n\t\t}\n\t}\n\n\t/** loopstart and loopend are in milliseconds */\n\tloadBgm(url: string, loopstart: number, loopend: number, replaceBGM?: BattleBGM | null) {\n\t\tif (replaceBGM) {\n\t\t\treplaceBGM.stop();\n\t\t\tthis.deleteBgm(replaceBGM);\n\t\t}\n\n\t\tconst bgm = new BattleBGM(url, loopstart, loopend);\n\t\tthis.bgm.push(bgm);\n\t\treturn bgm;\n\t}\n\tdeleteBgm(bgm: BattleBGM) {\n\t\tconst soundIndex = BattleSound.bgm.indexOf(bgm);\n\t\tif (soundIndex >= 0) BattleSound.bgm.splice(soundIndex, 1);\n\t}\n\n\tcurrentBgm() {\n\t\tif (!this.bgmVolume || this.muted) return false;\n\t\tfor (const bgm of this.bgm) {\n\t\t\tif (bgm.isPlaying) return bgm;\n\t\t}\n\t\treturn null;\n\t}\n\n\t// setting\n\tsetMute(muted: boolean) {\n\t\tmuted = !!muted;\n\t\tif (this.muted === muted) return;\n\t\tthis.muted = muted;\n\t\tBattleBGM.update();\n\t}\n\n\tloudnessPercentToAmplitudePercent(loudnessPercent: number) {\n\t\t// 10 dB is perceived as approximately twice as loud\n\t\tlet decibels = 10 * Math.log(loudnessPercent / 100) / Math.log(2);\n\t\treturn Math.pow(10, decibels / 20) * 100;\n\t}\n\tsetBgmVolume(bgmVolume: number) {\n\t\tthis.bgmVolume = this.loudnessPercentToAmplitudePercent(bgmVolume);\n\t\tBattleBGM.update();\n\t}\n\tsetEffectVolume(effectVolume: number) {\n\t\tthis.effectVolume = this.loudnessPercentToAmplitudePercent(effectVolume);\n\t}\n};\n\nif (typeof PS === 'object') {\n\tPS.prefs.subscribeAndRun(key => {\n\t\tif (!key || key === 'musicvolume' || key === 'effectvolume' || key === 'mute') {\n\t\t\tBattleSound.effectVolume = PS.prefs.effectvolume;\n\t\t\tBattleSound.bgmVolume = PS.prefs.musicvolume;\n\t\t\tBattleSound.muted = PS.prefs.mute;\n\t\t\tBattleBGM.update();\n\t\t}\n\t});\n}\n"],"mappings":"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"}